<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Barcode Scanner</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- QuaggaJS for barcode scanning -->
  <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.4/dist/quagga.min.js"></script>
  <style>
    #scanner-container {
      position: relative;
      width: 100%;
      max-width: 640px;
      margin: 0 auto;
    }
    #scanner-container video {
      width: 100%;
      border-radius: 8px;
    }
    .drawingBuffer {
      position: absolute;
      top: 0;
      left: 0;
    }
    .scan-line {
      position: absolute;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, transparent, #00ff00, transparent);
      animation: scan 2s linear infinite;
    }
    @keyframes scan {
      0%, 100% { top: 0; }
      50% { top: 100%; }
    }
    .result-box {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="row">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h3><i class="fa-solid fa-barcode me-2"></i>Barcode Scanner</h3>
          <button class="btn btn-secondary" onclick="window.close()">
            <i class="fa-solid fa-times me-2"></i>Close
          </button>
        </div>

        <div class="card">
          <div class="card-body">
            <div id="scanner-container" style="display: none;">
              <div class="scan-line"></div>
            </div>

            <div class="text-center" id="start-section">
              <i class="fa-solid fa-camera fa-4x text-primary mb-3"></i>
              <h5>Start Camera to Scan Barcode</h5>
              <p class="text-muted">Position the barcode within the camera view</p>
              <button class="btn btn-primary btn-lg" onclick="startScanner()">
                <i class="fa-solid fa-camera me-2"></i>Start Camera
              </button>
              <div class="mt-3">
                <button class="btn btn-outline-secondary" onclick="manualEntry()">
                  <i class="fa-solid fa-keyboard me-2"></i>Manual Entry
                </button>
              </div>
            </div>

            <div id="result-section" style="display: none;">
              <div class="result-box">
                <h5 class="text-success"><i class="fa-solid fa-check-circle me-2"></i>Barcode Detected!</h5>
                <div class="mt-3">
                  <strong>Barcode:</strong>
                  <h4 id="barcode-result" class="text-primary"></h4>
                </div>
                <div class="mt-3" id="product-info">
                  <!-- Product info will be loaded here -->
                </div>
                <div class="mt-3">
                  <button class="btn btn-success" onclick="useBarcode()">
                    <i class="fa-solid fa-check me-2"></i>Use This Barcode
                  </button>
                  <button class="btn btn-outline-primary" onclick="scanAgain()">
                    <i class="fa-solid fa-camera me-2"></i>Scan Again
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="alert alert-info mt-3">
          <strong><i class="fa-solid fa-info-circle me-2"></i>Tips:</strong>
          <ul class="mb-0">
            <li>Hold the barcode steady in front of the camera</li>
            <li>Ensure good lighting</li>
            <li>Keep the barcode flat and in focus</li>
            <li>Supported formats: EAN-13, UPC-A, Code 128, Code 39</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    let detectedBarcode = null;

    function startScanner() {
      document.getElementById('start-section').style.display = 'none';
      document.getElementById('scanner-container').style.display = 'block';

      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: document.querySelector('#scanner-container'),
          constraints: {
            width: 640,
            height: 480,
            facingMode: "environment"
          },
        },
        decoder: {
          readers: [
            "ean_reader",
            "ean_8_reader",
            "code_128_reader",
            "code_39_reader",
            "upc_reader",
            "upc_e_reader"
          ]
        },
      }, function(err) {
        if (err) {
          console.error(err);
          Swal.fire('Error', 'Failed to start camera: ' + err.message, 'error');
          document.getElementById('scanner-container').style.display = 'none';
          document.getElementById('start-section').style.display = 'block';
          return;
        }
        Quagga.start();
      });

      Quagga.onDetected(function(result) {
        const code = result.codeResult.code;
        console.log("Barcode detected:", code);
        
        // Stop scanner
        Quagga.stop();
        
        // Show result
        detectedBarcode = code;
        document.getElementById('scanner-container').style.display = 'none';
        document.getElementById('result-section').style.display = 'block';
        document.getElementById('barcode-result').textContent = code;
        
        // Fetch product info
        fetchProductInfo(code);
      });
    }

    async function fetchProductInfo(barcode) {
      try {
        const response = await fetch(`api/products.php?barcode=${barcode}`);
        const data = await response.json();
        
        const infoDiv = document.getElementById('product-info');
        
        if (data.ok && data.data) {
          const product = data.data;
          infoDiv.innerHTML = `
            <div class="alert alert-success">
              <h6><i class="fa-solid fa-box me-2"></i>Product Found!</h6>
              <p class="mb-1"><strong>Name:</strong> ${product.name}</p>
              <p class="mb-1"><strong>SKU:</strong> ${product.sku}</p>
              <p class="mb-0"><strong>Stock:</strong> ${product.total_stock || 0} units</p>
            </div>
          `;
        } else {
          infoDiv.innerHTML = `
            <div class="alert alert-warning">
              <i class="fa-solid fa-exclamation-triangle me-2"></i>
              Product not found in database. You can still use this barcode.
            </div>
          `;
        }
      } catch (error) {
        console.error('Error fetching product:', error);
      }
    }

    function scanAgain() {
      document.getElementById('result-section').style.display = 'none';
      startScanner();
    }

    function useBarcode() {
      if (window.opener) {
        // Send barcode back to parent window
        window.opener.postMessage({
          type: 'barcode_scanned',
          barcode: detectedBarcode
        }, '*');
        window.close();
      } else {
        Swal.fire('Success', `Barcode: ${detectedBarcode}`, 'success');
      }
    }

    async function manualEntry() {
      const { value: barcode } = await Swal.fire({
        title: 'Enter Barcode Manually',
        input: 'text',
        inputLabel: 'Barcode Number',
        inputPlaceholder: 'Enter barcode...',
        showCancelButton: true,
        inputValidator: (value) => {
          if (!value) {
            return 'Please enter a barcode!';
          }
        }
      });

      if (barcode) {
        detectedBarcode = barcode;
        document.getElementById('start-section').style.display = 'none';
        document.getElementById('result-section').style.display = 'block';
        document.getElementById('barcode-result').textContent = barcode;
        fetchProductInfo(barcode);
      }
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
      if (Quagga) {
        Quagga.stop();
      }
    });
  </script>
</body>
</html>
